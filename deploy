#!/bin/bash

if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <file_to_send> <user@remote_ip>"
    exit 1
fi

FILE_TO_SEND=$1
REMOTE_HOST=$2

if [ ! -f "$FILE_TO_SEND" ]; then
    echo "Error: File $FILE_TO_SEND does not exist."
    exit 1
fi

scp "$FILE_TO_SEND" "$REMOTE_HOST":~/ || { echo "Error: Failed to send file."; exit 1; }

LOG_FILE="~/cron_log_$(basename "$FILE_TO_SEND" .sh).log"
CRON_CMD="5 8-23,0 * * * { date +'%Y-%m-%d %H:%M:%S'; ~/$(basename "$FILE_TO_SEND"); } >> $LOG_FILE 2>&1"

ssh "$REMOTE_HOST" << EOF
    # Remove any existing cron job for this file
    crontab -l | grep -v "$(basename "$FILE_TO_SEND")" | crontab -

    # Add the new cron job with logging
    (crontab -l 2>/dev/null; echo "$CRON_CMD") | crontab -
    echo "Cron job set up successfully with logging to $LOG_FILE"
    echo "Current crontab:"
    crontab -l

    # Create the log file if it doesn't exist
    touch $LOG_FILE
    echo "Log file created: $LOG_FILE"
EOF

echo "cron build for $FILE_TO_SEND completed successfully."
